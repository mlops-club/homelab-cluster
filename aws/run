#!/bin/bash -euo pipefail

export AWS_REGION="us-west-2"
export AWS_DEFAULT_REGION="${AWS_REGION}"
export AWS_PROFILE="sandbox" # "mlops-club"

THIS_DIR="$(dirname "${BASH_SOURCE[0]}")"

function cdk-deploy {
    cdk deploy \
        --app "uv run $THIS_DIR/infra.py" \
        --profile "$AWS_PROFILE" \
        --region "$AWS_REGION" \
        --outputs-file "$THIS_DIR/stack-outputs.json"
}


function fetch-ssh-key {
    # delete the key first
    chmod 777 "$THIS_DIR/ssh-key" 2>/dev/null || true
    rm -rf "$THIS_DIR/ssh-key" || true
    mkdir -p "$THIS_DIR/ssh-key"

    # get the key pair id from the key pair name
    local kp_id
    kp_id=$(aws ec2 describe-key-pairs \
        --key-names "cluster-keypair" \
        --query 'KeyPairs[0].KeyPairId' \
        --output text \
        --profile "$AWS_PROFILE" \
        --region "$AWS_REGION") || return 1

    # Overwrite the ssh key using the key pair id
    local param_path="/ec2/keypair/${kp_id}"
    if ! aws ssm get-parameter \
        --name "$param_path" --with-decryption \
        --query "Parameter.Value" --output text \
        --profile "$AWS_PROFILE" \
        --region "$AWS_REGION" > "$THIS_DIR/ssh-key/private-key.pem"; then
    echo "Parameter not found: $param_path" >&2
    return 2
    fi

    chmod 400 "$THIS_DIR/ssh-key/private-key.pem"
}

# ./run connect-to-instance <index> [command...]
# Connects to the EC2 instance at the given index (starts at 0)
# If additional arguments are provided, they are executed as a command on the instance
function connect-to-instance {
    local index="${1:-0}"
    shift  # Remove the index from arguments
    local public_ip=$(aws cloudformation describe-stacks \
        --stack-name cluster \
        --profile "$AWS_PROFILE" \
        --region "$AWS_REGION" \
        --output json | jq -r ".Stacks[0].Outputs[]? | select(.OutputKey==\"Instance${index}PublicIP\") | .OutputValue")
    
    if [ -z "$public_ip" ] || [ "$public_ip" = "null" ]; then
        echo "No public IP found for instance $index"
        return 1
    fi
    
    if [ $# -gt 0 ]; then
        # Execute the command on the remote instance
        ssh -i "$THIS_DIR/ssh-key/private-key.pem" "ec2-user@${public_ip}" "$@"
    else
        # Interactive connection
        ssh -i "$THIS_DIR/ssh-key/private-key.pem" "ec2-user@${public_ip}"
    fi
}

# ./run fetch-kube-config <index>
# Fetches the kubeconfig file from the instance at the given index
function fetch-kube-config {

    set -x
    local index="${1:-0}"
    local filename=~/.kube/k3s-usw2.yaml
    
    connect-to-instance "$index" sudo cat /etc/rancher/k3s/k3s.yaml > "$filename"

    # merge the kubeconfig files
    KUBECONFIG=~/.kube/config:$filename kubectl config view --flatten > ~/.kube/config-merged
    mv ~/.kube/config-merged ~/.kube/config

    # in ~/.kube/config, replace any occurences of https://127.0.0.1:6443 with https://<public-ip>:6443
    local public_ip=$(aws cloudformation describe-stacks \
        --stack-name cluster \
        --profile "$AWS_PROFILE" \
        --region "$AWS_REGION" \
        --output json | jq -r ".Stacks[0].Outputs[]? | select(.OutputKey==\"Instance${index}PublicIP\") | .OutputValue")
    sed -i.bak "s|https://127.0.0.1:6443|https://${public_ip}:6443|g" ~/.kube/config
    rm -f ~/.kube/config.bak "$filename"
}


function cdk-destroy {
    cdk destroy \
        --app "uv run $THIS_DIR/infra.py" \
        --profile "$AWS_PROFILE" \
        --region "$AWS_REGION"
}

function cdk-bootstrap {
    AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query "Account" --output text --profile "$AWS_PROFILE")
    cdk bootstrap "aws://$AWS_ACCOUNT_ID/$AWS_REGION" --profile "$AWS_PROFILE"
}

function set-up-passwordless-ssh {
    # generate a new ssh key
    # ssh-keygen -t ed25519 -f ~/.ssh/id_ed25519 -N ""
    # copy it to each of the nodes
    for node in {1..3}; do
        ssh-copy-id -i "${HOME}/.ssh/id_ed25519.pub" "main@cluster-node-$node"
    done
}

function all {
    local cmd="$@"
    for node in {1..3}; do
        ssh "main@cluster-node-$node" "$cmd"
    done
}


function get-public-ips {
    # Get all instance public IPs from stack outputs
    local stack_outputs_file="$THIS_DIR/stack-outputs.json"
    
    if [ ! -f "$stack_outputs_file" ]; then
        echo "Stack outputs file not found: $stack_outputs_file" >&2
        echo "Please run 'cdk-deploy' first to create the stack." >&2
        return 1
    fi
    
    # Extract public IPs and return as an array
    jq --raw-output '.cluster | to_entries[] | select(.key | test("Instance[0-9]+PublicIP")) | .value' "$stack_outputs_file"
}

function create-inventory-file {
    local output_file="${1:-$THIS_DIR/../k3s-ansible/inventory.yaml}"
    
    echo "Creating inventory file at: $output_file"
    
    # Get public IPs
    local ips=()
    while IFS= read -r ip; do
        ips+=("$ip")
    done < <(get-public-ips)
    
    if [ ${#ips[@]} -eq 0 ]; then
        echo "No public IPs found. Make sure the CDK stack is deployed." >&2
        return 1
    fi
    
    echo "Found ${#ips[@]} instance(s): ${ips[*]}"
    
    # Use the first instance (index 0) as server, rest as agents
    local server_ip="${ips[0]}"
    local agent_ips=("${ips[@]:1}")
    
    # Create the inventory file
    cat > "$output_file" << EOF
---
k3s_cluster:
  children:
    server:
      hosts:
        ${server_ip}:
    agent:
      hosts:
EOF
    
    # Add agent hosts (if any)
    for agent_ip in "${agent_ips[@]}"; do
        echo "        ${agent_ip}:" >> "$output_file"
    done
    
    # Add the rest of the configuration
    cat >> "$output_file" << EOF

  # Required Vars
  vars:
    ansible_user: ec2-user
    ansible_ssh_private_key_file: ../aws/ssh-key/private-key.pem
EOF
    
    echo "Inventory file created successfully at: $output_file"
    echo "Server: $server_ip"
    if [ ${#agent_ips[@]} -gt 0 ]; then
        echo "Agents: ${agent_ips[*]}"
    else
        echo "No agent nodes (single-node cluster)"
    fi
}


function help {
    echo "Usage: $0 <command>"
    echo "Commands:"
    echo "  default - Run the default command"
    echo "  cdk-deploy - Deploy the CDK stack"
    echo "  cdk-destroy - Destroy the CDK stack"
    echo "  cdk-bootstrap - Bootstrap CDK in the region"
    echo "  fetch-ssh-key - Download the SSH private key from AWS"
    echo "  get-public-ips - Get the public IPs of all EC2 instances"
    echo "  create-inventory-file [output_file] - Create inventory.yml for K3s ansible"
    echo "  connect-to-instance <index> [command...] - SSH to instance (0-based index)"
    echo "  fetch-kube-config <index> - Fetch kubeconfig from instance"
    echo "  help - Show this help message"
}

time ${@:-help}